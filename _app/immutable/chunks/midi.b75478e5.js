var Z=Object.defineProperty;var I=(t,r,n)=>r in t?Z(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n;var h=(t,r,n)=>(I(t,typeof r!="symbol"?r+"":r,n),n);import{D as N,U as V,f as _}from"./2.2ee3d51f.js";import{s as G,f as x,g as U,h as R,d,i as p,A as y,I as M,o as D,p as T,a as H,e as F,c as j,j as A,v as K,H as z}from"./scheduler.eb66c082.js";import{S as J,i as W,b as E,d as ee,m as te,a as re,t as ne,e as ie}from"./index.847d8d55.js";import{E as se}from"./EventDispatcher.7485eed3.js";var Q=(t=>(t[t.VoiceNoteOff=8]="VoiceNoteOff",t[t.VoiceNoteOn=9]="VoiceNoteOn",t[t.VoiceAftertouch=10]="VoiceAftertouch",t[t.VoiceControlChange=11]="VoiceControlChange",t[t.VoiceProgramChange=12]="VoiceProgramChange",t[t.VoiceChannelPressure=13]="VoiceChannelPressure",t[t.VoicePitchBlend=14]="VoicePitchBlend",t[t.SystemExclusive=15]="SystemExclusive",t))(Q||{}),S=(t=>(t[t.SequenceNumber=0]="SequenceNumber",t[t.TextEvent=1]="TextEvent",t[t.CopyrightNotice=2]="CopyrightNotice",t[t.SequenceTrackName=3]="SequenceTrackName",t[t.InstrumentName=4]="InstrumentName",t[t.Lyric=5]="Lyric",t[t.Marker=6]="Marker",t[t.CuePoint=7]="CuePoint",t[t.MIDIChannelPrefix=32]="MIDIChannelPrefix",t[t.EndOfTrack=47]="EndOfTrack",t[t.SetTempo=81]="SetTempo",t[t.SMPTEOffset=84]="SMPTEOffset",t[t.TimeSignature=88]="TimeSignature",t[t.KeySignature=89]="KeySignature",t[t.SequencerSpecificMetaEvent=127]="SequencerSpecificMetaEvent",t))(S||{}),w=(t=>(t[t.Single=0]="Single",t[t.Simultaneous=1]="Simultaneous",t[t.Independent=2]="Independent",t))(w||{});class ae extends N{readVLQ(){let r=0;for(let n=0;n<4;n++){const i=this.readNumber("Uint8");if(r=r<<7|i&127,!(i&128))break}return r}readHeader(){this.assertMagic("MThd"),this.assertMagic(6,"Uint32");const r=this.readNumber("Uint16");if(!(r in w))throw new Error("MIDI header invalid format.");const n=this.readNumber("Uint16");if(r==0&&n!=1)throw new Error("MIDI header invalid format.");const i=this.readNumber("Uint16");if(i&32768){const s=(i&32512)>>8,e=i&255;return{format:r,numTracks:n,divFormat:"timecode",negativeSMPTEFormat:s,ticksPerFrame:e}}else return{format:r,numTracks:n,divFormat:"metrical",ticksPerQuarterNote:i}}readEvent(r,n){const i=(n&240)>>4,s=n&15;let e;switch(i){case 8:e={note:this.readVLQ(),velocity:this.readVLQ()};break;case 9:e={note:this.readVLQ(),velocity:this.readVLQ()};break;case 10:e={note:this.readVLQ(),pressure:this.readVLQ()};break;case 11:e={controller:this.readVLQ(),value:this.readVLQ()};break;case 12:e={program:this.readVLQ()};break;case 13:e={pressure:this.readVLQ()};break;case 14:e={pitch:this.readVLQ()<<7&this.readVLQ()};break;case 15:e={data:this.readBuffer(this.readVLQ())};break;default:throw new Error("Failed reading midi event.")}return{meta:!1,dt:r,type:i,channel:s,...e}}readMetaEvent(r){const n=this.readNumber("Uint8"),i=this.readVLQ(),s=this.pointer;let e;switch(n){case 0:e={sequence:this.readNumber("Uint16")};break;case 1:e={text:this.readString(i,"utf-8")};break;case 2:e={copyright:this.readString(i,"utf-8")};break;case 3:e={name:this.readString(i,"utf-8")};break;case 4:e={instrument:this.readString(i,"utf-8")};break;case 5:e={lyric:this.readString(i,"utf-8")};break;case 6:e={marker:this.readString(i,"utf-8")};break;case 7:e={description:this.readString(i,"utf-8")};break;case 32:e={channel:this.readNumber("Uint8")};break;case 47:e={};break;case 81:e={tempo:this.readCustomNumber(3,!1)};break;case 84:e={hour:this.readNumber("Uint8"),minute:this.readNumber("Uint8"),second:this.readNumber("Uint8"),frame:this.readNumber("Uint8"),fractionalFrame:this.readNumber("Uint8")};break;case 88:e={numerator:this.readNumber("Uint8"),denominator:Math.pow(2,this.readNumber("Uint8")),clocks:this.readNumber("Uint8"),notes:this.readNumber("Uint8")};break;case 89:e={signature:this.readNumber("Int8"),key:this.readNumber("Uint8")==0?"major":"minor"};break;case 127:{console.log("MIDI Skipped sequencer specific meta event."),e={data:this.readBuffer(i)};break}default:e={data:this.readBuffer(i)};break}if(this.pointer<s+i)console.warn(`Meta event ${S[n]} has invalid length.`),this.pointer=s+i;else if(this.pointer>s+i)throw new Error(`Meta event ${S[n]} length is too small for data.`);return{meta:!0,dt:r,type:n,...e}}readTrack(){this.assertMagic("MTrk");const r=this.readNumber("Uint32"),n=this.pointer;let i=[],s=0;for(;this.pointer-n<r;){const e=this.readVLQ();let a=this.readNumber("Uint8");a>128?s=a:(a=s,this.pointer--);const o=a==255?this.readMetaEvent(e):this.readEvent(e,a);if(i.push(o),o.meta&&o.type==47)break}return i}}function oe(t){const r=new ae(t);r.endianness=N.BIG_ENDIAN;const n=r.readHeader(),i=r.readArray(r.readTrack,n.numTracks);return{...n,tracks:i}}const g=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class C{constructor(r){h(this,"value");if(this.value=r,this.value<0||this.value>127||!Number.isInteger(this.value))throw new Error(`Invalid MIDI note. "${this.value}"`)}static fromNote(r){const[n,i]=r.split(" ");if(!n||!i)throw new Error(`Failed to convert note to midi note. "${r}"`);const s=parseInt(i);if(Number.isNaN(s))throw new Error(`Failed to convert note to midi note. "${r}"`);return new C(g.indexOf(n)+(s+1)*g.length)}getNote(){return`${g[this.value%g.length]} ${Math.floor(this.value/g.length)-1}`}}class ce extends se{constructor(n){super();h(this,"division");h(this,"tempo",120);h(this,"tracks");h(this,"_currentTick",0);if(n.format!=w.Single&&n.format!=w.Simultaneous)throw new Error(`Cannot play MIDI format "${w[n.format]}"`);if(n.divFormat!="metrical")throw new Error(`Cannot play time div format "${n.divFormat}"`);this.division=n.ticksPerQuarterNote,this.tracks=n.tracks.map(i=>{let s=0;return{index:0,finished:!1,events:i.map(e=>(s+=e.dt,{...e,acc:s})),totalTicks:s}})}get currentTick(){return this._currentTick}get totalTicks(){return this.tracks.reduce((n,i)=>i.totalTicks>n?i.totalTicks:n,0)}getTickMs(n){const i=6e7/this.tempo;return n*(6e4/(i*this.division))}finished(){return this.tracks.every(n=>n.finished)}tick(){let n=0;for(;n==0;){for(let i=0;i<this.tracks.length;i++){const s=this.tracks[i];if(s.finished)continue;const e=s.events[s.index];if(!(e.acc>this._currentTick)){if(e.meta==!1)e.type==Q.VoiceNoteOn?this.dispatchEvent("note",new C(e.note),e.velocity,e.channel,i):e.type==Q.VoiceNoteOff&&this.dispatchEvent("note",new C(e.note),e.velocity,e.channel,i);else if(e.type==S.SetTempo)this.tempo=e.tempo;else if(e.type==S.EndOfTrack){s.finished=!0;continue}if(s.index++,s.index>=s.events.length)throw new Error("MIDI player got to end of events without an end of track event.")}}n=this.tracks.reduce((i,s)=>{if(s.finished)return i;const e=s.events[s.index];return e.dt<i?e.dt:i},1/0),this._currentTick+=n}return this.getTickMs(n)}}function ue(t){let r;return{c(){r=x("div")},l(n){r=U(n,"DIV",{}),R(r).forEach(d)},m(n,i){p(n,r,i),t[1](r)},p:y,i:y,o:y,d(n){n&&d(r),t[1](null)}}}function le(t,r,n){const i=M();let s,e=V.getID().toString();D(()=>{const o=new MutationObserver(()=>{document.body.querySelector(`[RemoveDetector="${e}"]`)==null&&(o.disconnect(),i("remove"))});o.observe(document.body,{subtree:!0,childList:!0}),s.setAttribute("RemoveDetector",e)});function a(o){T[o?"unshift":"push"](()=>{s=o,n(0,s)})}return[s,a]}class de extends J{constructor(r){super(),W(this,r,le,ue,G,{})}}function B(t){let r,n,i;function s(o,u){return o[2]?he:fe}let e=s(t),a=e(t);return{c(){a.c(),r=H(),n=x("progress"),this.h()},l(o){a.l(o),r=j(o),n=U(o,"PROGRESS",{max:!0}),R(n).forEach(d),this.h()},h(){n.value=i=Math.floor(t[1]/t[0].totalTicks*100),A(n,"max",100)},m(o,u){a.m(o,u),p(o,r,u),p(o,n,u)},p(o,u){e===(e=s(o))&&a?a.p(o,u):(a.d(1),a=e(o),a&&(a.c(),a.m(r.parentNode,r))),u&3&&i!==(i=Math.floor(o[1]/o[0].totalTicks*100))&&(n.value=i)},d(o){o&&(d(r),d(n)),a.d(o)}}}function he(t){let r,n="Pause",i,s;return{c(){r=x("button"),r.textContent=n},l(e){r=U(e,"BUTTON",{"data-svelte-h":!0}),K(r)!=="svelte-wbaw1e"&&(r.textContent=n)},m(e,a){p(e,r,a),i||(s=z(r,"click",t[4]),i=!0)},p:y,d(e){e&&d(r),i=!1,s()}}}function fe(t){let r,n="Play",i,s;return{c(){r=x("button"),r.textContent=n},l(e){r=U(e,"BUTTON",{"data-svelte-h":!0}),K(r)!=="svelte-1pf6n9o"&&(r.textContent=n)},m(e,a){p(e,r,a),i||(s=z(r,"click",t[3]),i=!0)},p:y,d(e){e&&d(r),i=!1,s()}}}function me(t){let r,n,i,s;r=new de({}),r.$on("remove",t[6]);let e=t[0]&&B(t);return{c(){E(r.$$.fragment),n=H(),e&&e.c(),i=F()},l(a){ee(r.$$.fragment,a),n=j(a),e&&e.l(a),i=F()},m(a,o){te(r,a,o),p(a,n,o),e&&e.m(a,o),p(a,i,o),s=!0},p(a,[o]){a[0]?e?e.p(a,o):(e=B(a),e.c(),e.m(i.parentNode,i)):e&&(e.d(1),e=null)},i(a){s||(re(r.$$.fragment,a),s=!0)},o(a){ne(r.$$.fragment,a),s=!1},d(a){a&&(d(n),d(i)),ie(r,a),e&&e.d(a)}}}function pe(t,r,n){let{entry:i}=r,s,e=0,a,o=!1,u=-1;function $(){if(!o)return;n(1,e=s.currentTick);const v=s.tick();clearTimeout(u),u=setTimeout(()=>$(),v)}function X(){n(2,o=!0),$()}function O(){n(2,o=!1),a.stopAll(),clearTimeout(u)}class L{constructor(){h(this,"ctx",new AudioContext);h(this,"sounds",[])}static midiNoteToFreq(c){return 440*2**((c-69)/12)}start(c,k,b,f){const m=this.ctx.createGain();m.connect(this.ctx.destination),m.gain.value=1e-4,m.gain.exponentialRampToValueAtTime(5e-4*k,this.ctx.currentTime+.01);const l=this.ctx.createOscillator();l.connect(m),l.type="triangle",l.frequency.value=L.midiNoteToFreq(c.value),l.start(),this.sounds.push({gain:m,osc:l,note:c,channel:b,track:f})}stop(c,k,b){const f=this.sounds.findIndex(P=>P.note.value==c.value&&P.channel==k&&P.track==b);if(f==-1)return;const m=this.sounds.splice(f,1)[0],{gain:l,osc:q}=m;l.gain.setValueAtTime(l.gain.value,this.ctx.currentTime),l.gain.exponentialRampToValueAtTime(1e-4,this.ctx.currentTime+.1),setTimeout(()=>{l.disconnect(),q.stop(),q.disconnect()},100)}stopAll(){for(;this.sounds.length>0;){const c=this.sounds[0];this.stop(c.note,c.channel,c.track)}}}D(async()=>{const v=oe(await i.buffer());n(0,s=new ce(v)),a=new L,s.addEventListener("note",async(c,k,b,f)=>{k>0?a.start(c,k,b,f):a.stop(c,b,f)})});const Y=()=>{O(),s.destroyDispatcher()};return t.$$set=v=>{"entry"in v&&n(5,i=v.entry)},[s,e,o,X,O,i,Y]}class ve extends J{constructor(r){super(),W(this,r,pe,me,G,{entry:5})}}const Se={namespace:"midi.midi",priority:2,createViewer:async(t,r)=>{if(t.type==_.File)new ve({target:r,props:{entry:t}});else throw new Error("Tried to create midi viewer with directory.")},getIcon:async()=>"/asset-viewer/bootstrap-icons/file-earmark-music.svg"};export{Se as default};
