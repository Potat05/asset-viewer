var Z=Object.defineProperty;var j=(h,t,e)=>t in h?Z(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var u=(h,t,e)=>(j(h,typeof t!="symbol"?t+"":t,e),e);import{a as K,f as _,D}from"./2.1e08a865.js";import{s as H,f as q,g as X,h as Y,d as P,j as $,i as J,A as C,o as Q,Z as x,p as z}from"./scheduler.eb66c082.js";import{S as b,i as tt}from"./index.847d8d55.js";import{p as et}from"./pako.esm.29d98458.js";import{s as st,c as nt}from"./nbt.3a86d735.js";import{o as N,s as v,a as R,r as it,b as ot,n as w,l as rt,c as at,d as M,i as ct,T as lt}from"./ThreeUtils.924a2b70.js";import{M as ht,a as ft,B as dt,F as ut}from"./three.module.501e9167.js";import{E as pt}from"./EventDispatcher.7485eed3.js";const mt=N({Name:v(),Properties:R(it(v(),ot()))}),y={Name:"minecraft:air"},gt=N({DataVersion:w().int().min(0),xPos:w().int(),yPos:w().int(),zPos:w().int(),Status:rt("full").or(v()),LastUpdate:at().min(0n),sections:M(N({Y:w().int(),block_states:R(N({palette:M(mt),data:R(ct(BigInt64Array))}))})),block_entities:M(N({x:w().int(),y:w().int(),z:w().int(),id:v()}))});class T{constructor(t){u(this,"data");u(this,"cx");u(this,"cz");u(this,"sections");this.data=gt.parse(t),this.cx=this.data.xPos,this.cz=this.data.zPos,this.sections=new Array(this.data.sections.length);for(let e=0;e<this.data.sections.length;e++)this.sections[e]={y:this.data.sections[e].Y*16,type:"unset"}}deserializeSection(t){if(this.sections[t].type!="unset")return;if(this.data.DataVersion<2529){console.warn(`Chunk ${this.cx} ${this.cz} with unsupported data version.`),this.sections[t]={y:this.sections[t].y,type:"empty"};return}const e=this.data.sections[t].block_states;if(e==null){this.sections[t]={y:this.sections[t].y,type:"empty"};return}const s=e.data;if(e.palette.length==0){this.sections[t]={y:this.sections[t].y,type:"fill",fill:y};return}if(e.palette.length==1||s==null){this.sections[t]={y:this.sections[t].y,type:"fill",fill:e.palette[0]};return}const c=new Array(4096),n=Math.max(Math.ceil(Math.log2(e.palette.length)),4),a=BigInt((1<<n)-1),l=Math.floor(64/n);for(let p=0;p<4096;p++){const m=Math.floor(p/l),U=(p-m*l)*n,k=Number(s[m]>>BigInt(U)&a);if(k>=e.palette.length)throw new Error(`Error while deserializing section, palette index {${k}} is outside of palette {${e.palette.length}}.`);c[p]=e.palette[k]}this.sections[t]={y:this.sections[t].y,type:"blocks",blocks:c}}getSection(t){return this.sections[t]==null?null:(this.sections[t].type=="unset"&&this.deserializeSection(t),this.sections[t])}static getBlockSectionIndex(t,e,s){return(e&15)<<8|(s&15)<<4|t&15}getBlock(t,e,s){if(t<0||t>=16||s<0||s>=16)return y;const c=this.sections.findIndex(a=>e>=a.y&&e<a.y+16),n=this.getSection(c);if(n==null)return y;switch(n.type){case"unset":throw new Error("Deserialization failed.");case"empty":return y;case"fill":return n.fill;case"blocks":{const a=T.getBlockSectionIndex(t,e,s);return n.blocks[a]}}}forEachBlock(t){for(let e=0;e<this.sections.length;e++){const s=this.getSection(e);if(s==null)throw new Error("Failed to get section.");switch(s.type){case"unset":throw new Error("Deserialization failed.");case"empty":break;case"fill":{const c=s.fill;if(c.Name==y.Name)break;for(let n=0;n<16;n++)for(let a=0;a<16;a++)for(let l=0;l<16;l++)t(n,s.y+a,l,c);break}case"blocks":{for(let c=0;c<16;c++)for(let n=0;n<16;n++)for(let a=0;a<16;a++){const l=T.getBlockSectionIndex(c,n,a),p=s.blocks[l];p.Name!=y.Name&&t(c,s.y+n,a,p)}break}}}}}const S=32,E=S*S,G=4096;class wt{constructor(t,e,s){u(this,"file");u(this,"rx");u(this,"rz");u(this,"offsets",new Uint32Array(E));u(this,"lengths",new Uint8Array(E));this.file=t,this.rx=e,this.rz=s}async init(){const t=new D(await(await this.file.blob()).slice(0,4*E).arrayBuffer());t.endianness=D.BIG_ENDIAN;for(let e=0;e<E;e++)this.offsets[e]=t.readNumber("Uint8")<<16|t.readNumber("Uint8")<<8|t.readNumber("Uint8"),this.lengths[e]=t.readNumber("Uint8")}async getChunk(t,e){const s=(t&31)+(e&31)*S,c=this.offsets[s]*G,n=this.lengths[s]*G;if(c==0||n==0)return null;const a=new D(await(await this.file.blob()).slice(c,c+n).arrayBuffer());a.endianness=D.BIG_ENDIAN;const l=a.readNumber("Uint32");if(a.readNumber("Uint8")!=2)throw new Error("Invalid chunk compression method.");const m=st(nt(et.inflate(a.readBuffer(l-1))));return new T(m)}}class kt{constructor(t){u(this,"dir");this.dir=t}async getRegion(t,e){const s=await K.getDeep(this.dir,`region/r.${t}.${e}.mca`);return s==null||s.type!=_.File?null:new wt(s,t,e)}}function I(h,t,e,s){return Math.sqrt((h-e)**2+(t-s)**2)}class yt extends pt{constructor(e,s,c){super();u(this,"world");u(this,"renderDistance");u(this,"unloadDistance");u(this,"chunks",[]);u(this,"regions",[]);u(this,"isUpdating",!1);this.world=e,this.renderDistance=s,this.unloadDistance=c}async getRegion(e,s){const c=this.regions.find(l=>l.rx==e&&l.rz==s);if(c!=null)return c;const n=await this.world.getRegion(e,s);if(n==null){const l={type:"empty",rx:e,rz:s};return this.regions.push(l),l}await n.init();const a={type:"loaded",rx:e,rz:s,data:n};return this.regions.push(a),a}async loadChunk(e,s){if(this.chunks.some(a=>a.cx==e&&a.cz==s))return;const c=await this.getRegion(Math.floor(e/32),Math.floor(s/32));if(c.type!="loaded")return;const n=await c.data.getChunk(e,s);if(n==null){this.chunks.push({type:"empty",cx:e,cz:s});return}this.chunks.push({type:"loaded",cx:e,cz:s,data:n}),this.dispatchEvent("loadchunk",n)}async update(e,s){if(this.isUpdating)return;this.isUpdating=!0,this.chunks=this.chunks.filter(n=>I(e,s,n.cx,n.cz)>this.unloadDistance?(n.type=="loaded"&&this.dispatchEvent("unloadchunk",n.data),!1):!0);let c=[];for(let n=-this.renderDistance;n<this.renderDistance;n++)for(let a=-this.renderDistance;a<this.renderDistance;a++){const l=e+n,p=s+a;I(e,s,l,p)>this.renderDistance||this.chunks.some(m=>m.cx==l&&m.cz==p)||c.push({cx:l,cz:p})}for(;c.length>0;){const n=c.reduce((a,l)=>a==null||I(e,s,l.cx,l.cz)<I(e,s,a.cx,a.cz)?l:a);c.splice(c.indexOf(n),1),await this.loadChunk(n.cx,n.cz)}this.isUpdating=!1}}function Nt(h){let t;return{c(){t=q("canvas"),this.h()},l(e){t=X(e,"CANVAS",{class:!0}),Y(t).forEach(P),this.h()},h(){$(t,"class","svelte-rotshb")},m(e,s){J(e,t,s),h[2](t)},p:C,i:C,o:C,d(e){e&&P(t),h[2](null)}}}function Bt(h,t,e){let{entry:s}=t,c,n,a=-1,l;Q(async()=>{const m=new kt(s),{scene:U,camera:k,controls:F,dispose:V}=lt.createRendererWithControls({canvas:c});F.moveSpeed=.1,l=V;function W(d){let f=[];d.forEachBlock((i,o,r,Et)=>{d.getBlock(i+1,o,r).Name=="minecraft:air"&&f.push(i+1,o,r,i+1,o+1,r,i+1,o,r+1,i+1,o+1,r,i+1,o+1,r+1,i+1,o,r+1),d.getBlock(i-1,o,r).Name=="minecraft:air"&&f.push(i,o+1,r,i,o,r,i,o,r+1,i,o+1,r+1,i,o+1,r,i,o,r+1),d.getBlock(i,o+1,r).Name=="minecraft:air"&&f.push(i+1,o+1,r,i,o+1,r,i,o+1,r+1,i+1,o+1,r+1,i+1,o+1,r,i,o+1,r+1),d.getBlock(i,o-1,r).Name=="minecraft:air"&&f.push(i,o,r,i+1,o,r,i,o,r+1,i+1,o,r,i+1,o,r+1,i,o,r+1),d.getBlock(i,o,r+1).Name=="minecraft:air"&&f.push(i,o,r+1,i+1,o,r+1,i,o+1,r+1,i+1,o,r+1,i+1,o+1,r+1,i,o+1,r+1),d.getBlock(i,o,r-1).Name=="minecraft:air"&&f.push(i+1,o,r,i,o,r,i,o+1,r,i+1,o+1,r,i+1,o,r,i,o+1,r)});const g=new dt;return g.setAttribute("position",new ut(f,3)),g}let B=[];n=new yt(m,8,10),n.addEventListener("loadchunk",d=>{const f=W(d);f.computeVertexNormals();const g=new ht(f,new ft);g.translateX(d.cx*16),g.translateZ(d.cz*16),U.add(g),B.push({mesh:g,chunk:d})}),n.addEventListener("unloadchunk",d=>{const f=B.find(g=>g.chunk==d);if(f==null)throw new Error("Error while unloading chunk.");f.mesh.clear(),f.mesh.removeFromParent(),B=B.filter(g=>g!=f)});let A,L;async function O(){const d=Math.floor(k.position.x/16),f=Math.floor(k.position.z/16);(d!=A||f!=L)&&(await n.update(d,f),A=d,L=f),clearTimeout(a),a=setTimeout(()=>O(),500)}O()}),x(()=>{l(),n.destroyDispatcher(),clearTimeout(a)});function p(m){z[m?"unshift":"push"](()=>{c=m,e(0,c)})}return h.$$set=m=>{"entry"in m&&e(1,s=m.entry)},[c,s,p]}class Dt extends b{constructor(t){super(),tt(this,t,Bt,Nt,H,{entry:1})}}const At={namespace:"minecraft.world",priority:2,createViewer:async(h,t)=>{if(h.type==_.Directory)new Dt({target:t,props:{entry:h}});else throw new Error("Tried to create world viewer with file.")},getIcon:async h=>{if(h.type==_.Directory){const t=await h.get("icon.png");return t==null?"/asset-viewer/bootstrap-icons/boxes.svg":t.type==_.Directory?null:URL.createObjectURL(await t.blob())}return null}};export{At as default};
